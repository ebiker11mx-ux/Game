<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>3D Obstacle Course - Mobile Friendly</title>
<style>
  html, body { margin:0; height:100%; background:#0d1117; overflow:hidden; font-family:system-ui, Arial; }
  #game { position:fixed; inset:0; }

  .hud { position:fixed; inset:0; pointer-events:none; }
  .status { position:absolute; top:8px; left:8px; color:#eaf1ff; font-size:13px; background:rgba(0,0,0,0.35); padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); }
  .status strong { color:#fff; }

  /* Arrow controls */
  .arrows {
    position:absolute;
    bottom:12px;
    left:12px;
    display:grid;
    grid-template-columns:64px 64px 64px;
    grid-template-rows:64px 64px;
    gap:6px;
    pointer-events:auto;
  }
  .arrow {
    font-size:22px;
    border-radius:14px;
    box-shadow:0 6px 20px rgba(22,99,217,0.35);
    background: linear-gradient(180deg,#3a8ffd,#1663d9);
    color:#fff;
    font-weight:700;
  }
  .arrow:active {
    transform: translateY(2px);
    box-shadow: 0 3px 10px rgba(22,99,217,0.35);
  }
  .arrow.blank { background:transparent; border:none; box-shadow:none; }

  /* Jump buttons */
  .buttons {
    position:absolute;
    bottom:12px;
    right:12px;
    display:flex;
    gap:12px;
    pointer-events:auto;
  }
  .btn {
    min-width:64px;
    min-height:64px;
    border-radius:14px;
    background:linear-gradient(180deg,#3a8ffd,#1663d9);
    color:#fff;
    font-weight:700;
    border:none;
    font-size:14px;
    box-shadow:0 6px 20px rgba(22,99,217,0.35);
  }
  .btn.secondary { background:linear-gradient(180deg,#ff9b3a,#d95c16); box-shadow:0 6px 20px rgba(217,92,22,0.35); }
  .btn:active { transform:translateY(2px); box-shadow:0 3px 10px rgba(0,0,0,0.35); }

  /* Finish banner */
  .banner { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
  .card { background:rgba(13,17,23,0.92); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px 18px; color:#fff; min-width:280px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
  .card h2 { margin:0 0 8px; font-size:20px; }
  .card p { margin:6px 0; font-size:14px; color:#cfe1ff; }
  .card .row { display:flex; gap:12px; justify-content:center; margin-top:10px; }
  .card button { padding:10px 14px; border-radius:10px; border:none; font-weight:700; }
  .card .primary { background:#3a8ffd; color:#fff; }
  .card .ghost { background:transparent; color:#9fb7ff; border:1px solid rgba(255,255,255,0.18); }

  @media (max-width:480px) {
    .arrows { grid-template-columns:56px 56px 56px; grid-template-rows:56px 56px; gap:4px; }
    .arrow { font-size:20px; }
    .btn { min-width:56px; min-height:56px; font-size:13px; }
    .status { font-size:12px; padding:5px 8px; }
  }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="hud">
  <div class="arrows">
    <button class="arrow blank" disabled></button>
    <button id="upBtn" class="arrow" aria-label="Move up">⬆️</button>
    <button class="arrow blank" disabled></button>

    <button id="leftBtn" class="arrow" aria-label="Move left">⬅️</button>
    <button id="downBtn" class="arrow" aria-label="Move down">⬇️</button>
    <button id="rightBtn" class="arrow" aria-label="Move right">➡️</button>
  </div>

  <div class="buttons">
    <button id="jumpBtn" class="btn" aria-label="Jump">Jump</button>
    <button id="doubleJumpBtn" class="btn secondary" aria-label="Double jump">Double</button>
  </div>

  <div class="status">
    <div><strong>Checkpoint:</strong> <span id="checkpointIdx">0</span> / <span id="checkpointTotal">0</span></div>
    <div><strong>Coins:</strong> <span id="coinCount">0</span></div>
    <div><strong>Time:</strong> <span id="timer">0.0s</span></div>
  </div>

  <div id="finishBanner" class="banner" style="display:none;">
    <div class="card">
      <h2>Level complete!</h2>
      <p id="resultTime">Time: 0.00s</p>
      <p id="resultCoins">Coins: 0</p>
      <div class="row">
        <button id="restartBtn" class="primary">Restart</button>
        <button id="resumeBtn" class="ghost">Free roam</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  const canvas = document.getElementById('game');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0d1117);
  scene.fog = new THREE.Fog(0x0a0f18, 60, 180);

  const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 800);
  camera.position.set(0, 8, 12);

  // Lights
  scene.add(new THREE.HemisphereLight(0xffffff, 0x223355, 0.7));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(12,18,10);
  scene.add(dir);

  // Ground
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000), new THREE.MeshStandardMaterial({color:0x0b0f18, roughness:1}));
  ground.rotation.x = -Math.PI/2;
  scene.add(ground);

  // Player
  const playerRadius = 0.6;
  const player = new THREE.Mesh(new THREE.SphereGeometry(playerRadius, 20, 16), new THREE.MeshStandardMaterial({color:0x86b9ff, emissive:0x001838, roughness:0.4, metalness:0.15}));
  scene.add(player);

  // State
  const state = {
    pos: new THREE.Vector3(0,2,0),
    vel: new THREE.Vector3(0,0,0),
    acc: new THREE.Vector3(0,0,0),
    onGround:false,
    jumpCount:0,
    lastCheckpoint:new THREE.Vector3(0,2,0),
    checkpointIndex:0,
    coins:0,
    startTime: performance.now(),
    finished:false
  };

  // HUD refs
  const checkpointIdxEl = document.getElementById('checkpointIdx');
  const checkpointTotalEl = document.getElementById('checkpointTotal');
  const coinCountEl = document.getElementById('coinCount');
  const timerEl = document.getElementById('timer');
  const finishBanner = document.getElementById('finishBanner');
  const resultTimeEl = document.getElementById('resultTime');
  const resultCoinsEl = document.getElementById('resultCoins');
  const restartBtn = document.getElementById('restartBtn');
  const resumeBtn = document.getElementById('resumeBtn');

  // Platforms
  const platforms = [];
  const platformGroup = new THREE.Group();
  scene.add(platformGroup);

  const makePlatform = (w,h,d,x,y,z,opts={}) => {
    const plat = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color:opts.color||0x2a3758, emissive:opts.emissive||0x000000, roughness:0.7}));
    plat.position.set(x,y,z);
    plat.userData = { size:{w,h,d}, isMoving:!!opts.isMoving, moveAxis:opts.moveAxis||'x', moveAmp:opts.moveAmp||0, moveSpeed:opts.moveSpeed||0, basePos:new THREE.Vector3(x,y,z), index:platforms.length+1 };
    platformGroup.add(plat);
    platforms.push(plat);
    return plat;
  };

  let zOffset = 0;
  const startCount=6, midCount=10, endCount=8;
  const totalCount = startCount+midCount+endCount;
  checkpointTotalEl.textContent = totalCount;

  // Start section
  for(let i=0;i<startCount;i++){
    const w=6-i*0.2,d=6-i*0.2,gap=4+i*0.25;
    zOffset -= gap;
    makePlatform(w,0.8,d,(Math.random()-0.5)*2,0.6,zOffset);
  }

  // Mid section
  for(let i=0;i<midCount;i++){
    const w=4.6-i*0.2,d=3.6-i*0.2,gap=5+i*0.45;
    zOffset -= gap;
    const x=Math.sin(i*0.65)*3;
    makePlatform(w,0.7,d,x,1.1,zOffset);
  }

  // End section moving
  for(let i=0;i<endCount;i++){
    const w=3.2,d=2.6,gap=6+i*0.55;
    zOffset -= gap;
    const axis = i%2===0?'x':'y';
    const amp = axis==='x'?2.2:0.8;
    const speed=0.8+i*0.06;
    makePlatform(w,0.6,d,0,1.5,zOffset,{isMoving:true, moveAxis:axis, moveAmp:amp, moveSpeed:speed, color:0x25406a, emissive:0x06122a});
  }

  // Spawn player
  state.pos.copy(platforms[0].position).add(new THREE.Vector3(0,2,0));
  state.lastCheckpoint.copy(state.pos);
  state.checkpointIndex = 1;
  checkpointIdxEl.textContent = state.checkpointIndex;

  // Coins
  const coins = [];
  const coinGeo = new THREE.TorusGeometry(0.4,0.15,12,24);
  const coinMat = new THREE.MeshStandardMaterial({color:0xffd700, emissive:0x332200, roughness:0.35});
  for(let i=1;i<totalCount-1;i++){
    const plat=platforms[i];
    const c = new THREE.Mesh(coinGeo,coinMat);
    const jitterX=(Math.random()-0.5)*Math.min(plat.userData.size.w-1,2.5);
    const jitterZ=(Math.random()-0.5)*Math.min(plat.userData.size.d-1,2.5);
    c.position.set(plat.position.x+jitterX, plat.position.y+1.4, plat.position.z+jitterZ);
    c.rotation.x=Math.PI/2;
    scene.add(c);
    coins.push(c);
  }

  // Finish portal
  const lastPlat = platforms[platforms.length-1];
  const portal = new THREE.Mesh(new THREE.RingGeometry(2,2.6,48), new THREE.MeshBasicMaterial({color:0x00ffcc, side:THREE.DoubleSide}));
  portal.position.set(lastPlat.position.x, lastPlat.position.y+1.6, lastPlat.position.z-4);
  portal.rotation.y=Math.PI/2;
  scene.add(portal);

  // Input
  const input = {x:0,z:0};
  function bindArrow(id,dx,dz){
    const btn = document.getElementById(id);
    const start = e=>{ input.x+=dx; input.z+=dz; e.preventDefault(); };
    const end = ()=>{ input.x-=dx; input.z-=dz; };
    btn.addEventListener('touchstart', start, {passive:false});
    btn.addEventListener('touchend', end);
    btn.addEventListener('touchcancel', end);
    btn.addEventListener('mousedown', start);
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
  }
  bindArrow('upBtn',0,-1);
  bindArrow('downBtn',0,1);
  bindArrow('leftBtn',-1,0);
  bindArrow('rightBtn',1,0);

  const jumpBtn = document.getElementById('jumpBtn');
  const doubleJumpBtn = document.getElementById('doubleJumpBtn');
  const tryJump = (force=9.2)=>{
    if(state.onGround && !state.finished){ state.vel.y=force; state.onGround=false; state.jumpCount=1; }
  };
  const tryDoubleJump = (force=9)=>{
    if(!state.onGround && state.jumpCount===1 && !state.finished){ state.vel.y=force; state.jumpCount=2; }
  };
  let jumpLocked=false;
  jumpBtn.addEventListener('touchstart', e=>{ if(!jumpLocked){ tryJump(); jumpLocked=true; e.preventDefault(); } }, {passive:false});
  jumpBtn.addEventListener('touchend', e=>{ jumpLocked=false; e.preventDefault(); });
  jumpBtn.addEventListener('click', tryJump);
  doubleJumpBtn.addEventListener('touchstart', e=>{ tryDoubleJump(); e.preventDefault(); }, {passive:false});
  doubleJumpBtn.addEventListener('click', tryDoubleJump);

  // Prevent scroll
  document.body.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});

  // Desktop keys
  const keys = {};
  window.addEventListener('keydown', e=>keys[e.code]=true);
  window.addEventListener('keyup', e=>keys[e.code]=false);
  function applyDesktopInput(){
    const kx=(keys['KeyA']?-1:0)+(keys['KeyD']?1:0);
    const kz=(keys['KeyW']?-1:0)+(keys['KeyS']?1:0);
    input.x=kx;
    input.z=kz;
    if(keys['Space']){ tryJump(); keys['Space']=false; }
    if(keys['ShiftLeft']||keys['ShiftRight']){ tryDoubleJump(); keys['ShiftLeft']=keys['ShiftRight']=false; }
  }

  // Physics
  const GRAVITY=-20, MOVE_ACCEL=26, AIR_ACCEL=12, MAX_SPEED=8.5, FRICTION=14;

  function groundHeightAt(pos){
    let hitHeight=-Infinity, hitPlat=null;
    for(let plat of platforms){
      const {w,h,d}=plat.userData.size;
      const p=plat.position;
      if(pos.x>=p.x-w/2-playerRadius && pos.x<=p.x+w/2+playerRadius &&
         pos.z>=p.z-d/2-playerRadius && pos.z<=p.z+d/2+playerRadius){
        const top = p.y + h/2;
        if(top>hitHeight){ hitHeight=top; hitPlat=plat; }
      }
    }
    return {height:hitHeight, plat:hitPlat};
  }

  function updateMovingPlatforms(t){
    for(let plat of platforms){
      const ud=plat.userData;
      if(!ud.isMoving) continue;
      const phase=Math.sin(t*ud.moveSpeed);
      if(ud.moveAxis==='x') plat.position.x=ud.basePos.x+phase*ud.moveAmp;
      else if(ud.moveAxis==='y') plat.position.y=ud.basePos.y+phase*ud.moveAmp;
    }
  }

  function updateHUD(now){
    if(!state.finished){
      const elapsed=(now-state.startTime)/1000;
      timerEl.textContent=`${elapsed.toFixed(1)}s`;
    }
    coinCountEl.textContent=state.coins;
    checkpointIdxEl.textContent=state.checkpointIndex;
  }

  function showFinish(now){
    const elapsed=(now-state.startTime)/1000;
    finishBanner.style.display='flex';
    resultTimeEl.textContent=`Time: ${elapsed.toFixed(2)}s`;
    resultCoinsEl.textContent=`Coins: ${state.coins}`;
  }

  restartBtn.addEventListener('click', ()=>{
    state.finished=false;
    state.pos.copy(platforms[0].position).add(new THREE
