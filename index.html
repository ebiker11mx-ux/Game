<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>3D Endless Obby</title>
<style>
body { margin:0; overflow:hidden; background:black; font-family:sans-serif; }
canvas { display:block; }

.ui { position:fixed; bottom:20px; width:100%; display:flex; justify-content:space-between; padding:0 20px; pointer-events:none; }
.joystick { width:120px; height:120px; background:rgba(255,255,255,0.25); border-radius:50%; position:relative; pointer-events:auto; }
.stick { width:50px; height:50px; background:rgba(255,255,255,0.9); border-radius:50%; position:absolute; top:35px; left:35px; }
.buttons { display:flex; flex-direction:column; gap:15px; pointer-events:auto; }
button { width:70px; height:70px; border-radius:50%; border:none; font-size:18px; background:rgba(255,255,255,0.85); }

.message { position:fixed; top:20px; width:100%; text-align:center; font-size:28px; color:yellow; text-shadow:0 0 8px black; pointer-events:none; }
</style>
</head>
<body>

<div class="ui">
  <div class="joystick" id="joystick"><div class="stick" id="stick"></div></div>
  <div class="buttons">
    <button id="highjump">⬆⬆</button>
    <button id="jump">⤒</button>
  </div>
</div>

<div class="message" id="message"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
// ---------------- SCENE ----------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);
scene.add(new THREE.DirectionalLight(0xffffff,1).position.set(5,10,5));
scene.add(new THREE.AmbientLight(0xffffff,0.4));

// ---------------- PLAYER ----------------
const player = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color:0xff4444 }));
player.position.set(0,2,0);
scene.add(player);

// ---------------- VARIABLES ----------------
let platforms=[], checkpointPos=new THREE.Vector3(0,2,0);
const message=document.getElementById("message");
let velocityY=0, onGround=false, speed=0.12, gravity=0.02;
let platformIndex=0, difficulty=0.05;

// ---------------- JOYSTICK ----------------
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyX=0, joyY=0;

joystick.addEventListener("touchmove", e=>{
  const rect=joystick.getBoundingClientRect();
  const touch=e.touches[0];
  let x=touch.clientX-rect.left-60;
  let y=touch.clientY-rect.top-60;
  const dist=Math.min(40, Math.hypot(x,y));
  const angle=Math.atan2(y,x);
  joyX=Math.cos(angle)*(dist/40);
  joyY=Math.sin(angle)*(dist/40);
  stick.style.left=35+joyX*40+"px";
  stick.style.top=35+joyY*40+"px";
});
joystick.addEventListener("touchend", ()=>{ joyX=joyY=0; stick.style.left="35px"; stick.style.top="35px"; });

// ---------------- BUTTONS ----------------
document.getElementById("jump").ontouchstart=()=>{ if(onGround){ velocityY=0.35; onGround=false; } };
document.getElementById("highjump").ontouchstart=()=>{ if(onGround){ velocityY=0.65; onGround=false; } };

// ---------------- PLATFORM GENERATOR ----------------
function createPlatform(x=0,y=0,z=0,move=false){
  const p = new THREE.Mesh(
    new THREE.BoxGeometry(move?3:5,1,5),
    new THREE.MeshStandardMaterial({color: move?0xffaa00:0x22ff22})
  );
  p.position.set(x,y,z);
  scene.add(p);
  platforms.push({mesh:p, move:move, startX:x, dir:1});
}

// Initialize first 10 platforms
for(let i=0;i<10;i++){
  const x = Math.floor(Math.random()*5-2);
  const y = i*0.5;
  const z = -i*8;
  const move = Math.random() < 0.3;
  createPlatform(x,y,z,move);
}

// ---------------- GAME LOOP ----------------
function animate(){
  requestAnimationFrame(animate);

  // Movement
  player.position.x += joyX*speed;
  player.position.z += joyY*speed;

  // Gravity
  velocityY -= gravity; player.position.y += velocityY;

  // Moving platforms
  platforms.forEach(p=>{
    if(p.move){ 
      p.mesh.position.x += difficulty*p.dir; 
      if(Math.abs(p.mesh.position.x-p.startX)>3) p.dir*=-1; 
    }
  });

  // Collision & checkpoint
  onGround=false;
  platforms.forEach((p,i)=>{
    const dx=Math.abs(player.position.x-p.mesh.position.x);
    const dz=Math.abs(player.position.z-p.mesh.position.z);
    const dy=player.position.y-p.mesh.position.y;
    if(dx<2.5 && dz<2.5 && dy<=1 && dy>0){
      velocityY=0; player.position.y=p.mesh.position.y+1; onGround=true;
      checkpointPos.copy(new THREE.Vector3(p.mesh.position.x,p.mesh.position.y+1,p.mesh.position.z));
    }
  });

  // Respawn if fall
  if(player.position.y<-20){ player.position.copy(checkpointPos); velocityY=0; }

  // Generate new platforms ahead
  const lastPlatform = platforms[platforms.length-1].mesh;
  if(player.position.z - lastPlatform.position.z < 40){
    const x = Math.floor(Math.random()*5-2);
    const y = lastPlatform.position.y + Math.random()*0.5;
    const z = lastPlatform.position.z - 8;
    const move = Math.random() < 0.3;
    createPlatform(x,y,z,move);

    // Increase difficulty slightly over time
    difficulty += 0.0005;
  }

  // Remove platforms behind player
  if(platforms[0].mesh.position.z - player.position.z > 20){
    scene.remove(platforms[0].mesh);
    platforms.shift();
  }

  // Camera follow
  camera.position.set(player.position.x, player.position.y+6, player.position.z+12);
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
animate();

// ---------------- RESIZE ----------------
addEventListener("resize",()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
