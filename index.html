<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>3D Obstacle Course Game</title>
<style>
  html, body { margin:0; height:100%; background:#0d1117; overflow:hidden; }
  #game { position:fixed; inset:0; }
  .hud { position:fixed; inset:0; pointer-events:none; }
  .controls { position:absolute; bottom:16px; left:16px; width:160px; height:160px; pointer-events:auto; }
  .joystick { position:relative; width:100%; height:100%; border-radius:50%; background:rgba(255,255,255,0.05); border:2px solid rgba(255,255,255,0.1); }
  .stick { position:absolute; left:50%; top:50%; width:70px; height:70px; transform:translate(-50%,-50%); border-radius:50%; background:rgba(255,255,255,0.25); }
  .buttons { position:absolute; bottom:16px; right:16px; display:flex; gap:12px; pointer-events:auto; }
  .btn { min-width:86px; min-height:86px; border-radius:12px; background:#3a8ffd; color:#fff; font-weight:bold; border:none; }
  .btn.secondary { background:#ff9b3a; }
  .status { position:absolute; top:12px; left:12px; color:#fff; font-size:14px; background:rgba(0,0,0,0.4); padding:6px 10px; border-radius:8px; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud">
  <div class="controls">
    <div id="joystick" class="joystick"><div id="stick" class="stick"></div></div>
  </div>
  <div class="buttons">
    <button id="jumpBtn" class="btn">Jump</button>
    <button id="doubleJumpBtn" class="btn secondary">Double</button>
  </div>
  <div class="status">
    <div>Checkpoint: <span id="checkpointIdx">0</span></div>
    <div>Coins: <span id="coinCount">0</span></div>
    <div>Time: <span id="timer">0.0s</span></div>
  </div>
</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  const canvas = document.getElementById('game');
  const renderer = new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0d1117);
  const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 500);
  camera.position.set(0,8,12);

  // Lights
  scene.add(new THREE.HemisphereLight(0xffffff,0x223355,0.6));
  const dir = new THREE.DirectionalLight(0xffffff,0.9);
  dir.position.set(10,20,10); scene.add(dir);

  // Player
  const player = new THREE.Mesh(new THREE.SphereGeometry(0.6,24,16),
    new THREE.MeshStandardMaterial({color:0x86b9ff}));
  scene.add(player);

  const state = {pos:new THREE.Vector3(0,2,0), vel:new THREE.Vector3(), onGround:false,
    jumpCount:0, lastCheckpoint:new THREE.Vector3(0,2,0), checkpointIndex:0, coins:0, startTime:performance.now()};

  // Platforms
  const platforms=[], group=new THREE.Group(); scene.add(group);
  let zOffset=0;
  for(let i=0;i<15;i++){ zOffset-=5;
    const plat=new THREE.Mesh(new THREE.BoxGeometry(5-i*0.2,0.8,5-i*0.2),
      new THREE.MeshStandardMaterial({color:0x2a3758}));
    plat.position.set((Math.random()-0.5)*4,0.5,zOffset);
    plat.userData.index=i+1;
    group.add(plat); platforms.push(plat);
  }

  // Coins
  const coinGeo=new THREE.TorusGeometry(0.4,0.15,12,24);
  const coinMat=new THREE.MeshStandardMaterial({color:0xffd700,emissive:0x442200});
  const coins=[];
  for(let i=0;i<10;i++){ const c=new THREE.Mesh(coinGeo,coinMat);
    c.position.set((Math.random()-0.5)*4,2,-i*8-10); scene.add(c); coins.push(c); }

  // Finish portal
  const portal=new THREE.Mesh(new THREE.RingGeometry(2,2.5,32),
    new THREE.MeshBasicMaterial({color:0x00ffcc,side:THREE.DoubleSide}));
  portal.rotation.y=Math.PI/2; portal.position.set(0,2,zOffset-10); scene.add(portal);

  // Joystick
  const joystick=document.getElementById('joystick'), stick=document.getElementById('stick');
  let joyVector=new THREE.Vector2(0,0), joyActive=false, joyCenter=null;
  const JOY_RADIUS=joystick.clientWidth*0.5-stick.clientWidth*0.5;
  const setStick=(dx,dy)=>{stick.style.transform=`translate(${dx-stick.clientWidth/2}px,${dy-stick.clientHeight/2}px)`;};
  const joyStart=(x,y)=>{const r=joystick.getBoundingClientRect(); joyCenter=new THREE.Vector2(r.left+r.width/2,r.top+r.height/2); joyActive=true; joyMove(x,y);};
  const joyMove=(x,y)=>{if(!joyActive)return; const v=new THREE.Vector2(x-joyCenter.x,y-joyCenter.y); const len=Math.min(v.length(),JOY_RADIUS); v.setLength(len); setStick(v.x+joystick.clientWidth/2,v.y+joystick.clientHeight/2); joyVector.set(v.x/JOY_RADIUS,-v.y/JOY_RADIUS);};
  const joyEnd=()=>{joyActive=false; joyVector.set(0,0); setStick(joystick.clientWidth/2,joystick.clientHeight/2);};
  joystick.addEventListener('touchstart',e=>joyStart(e.touches[0].clientX,e.touches[0].clientY));
  joystick.addEventListener('touchmove',e=>joyMove(e.touches[0].clientX,e.touches[0].clientY));
  joystick.addEventListener('touchend',joyEnd);

  // Jump buttons
  document.getElementById('jumpBtn').onclick=()=>{if(state.onGround){state.vel.y=9; state.onGround=false; state.jumpCount=1;}};
  document.getElementById('doubleJumpBtn').onclick=()=>{if(!state.onGround&&state.jumpCount===1){state.vel.y=9; state.jumpCount=2;}};

  // Physics constants
  const GRAVITY=-20, MOVE_ACCEL=28, AIR_ACCEL=12, MAX_SPEED=8.5, FRICTION=14;

  function loop(){
    const dt=0.016;
    // Movement
    const accel=state.onGround?MOVE_ACCEL:AIR_ACCEL;
    state.vel.x+=joyVector.x*accel*dt;
    state.vel.z+=joyVector.y*accel*dt;
    state.vel.y+=GRAVITY*dt;
    state.pos.addScaledVector(state.vel,dt);

    // Collision with platforms
    state.onGround=false;
    for(const plat of platforms){
      const p=plat.position; const w=plat.geometry.parameters.width, d=plat.geometry.parameters.depth;
      if(state.pos.x>p.x-w/2&&state.pos.x<p.x+w/2&&state.pos.z>p.z-d/2&&state.pos.z<p.z+d/2){
        const top=p.y+0.4;
        if(state.pos.y-0.6<=top&&state.vel.y<=0){state.pos.y=top+0.6; state.vel.y=0; state.onGround=true
