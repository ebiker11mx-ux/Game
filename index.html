<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>3D Mobile Obby 5 Levels</title>
<style>
body { margin:0; overflow:hidden; background:black; }
canvas { display:block; }

.ui { position:fixed; bottom:20px; width:100%; display:flex; justify-content:space-between; padding:0 20px; pointer-events:none; }
.joystick { width:120px; height:120px; background:rgba(255,255,255,0.25); border-radius:50%; position:relative; pointer-events:auto; }
.stick { width:50px; height:50px; background:rgba(255,255,255,0.9); border-radius:50%; position:absolute; top:35px; left:35px; }
.buttons { display:flex; flex-direction:column; gap:15px; pointer-events:auto; }
button { width:70px; height:70px; border-radius:50%; border:none; font-size:18px; background:rgba(255,255,255,0.85); }
.message { position:fixed; top:20px; width:100%; text-align:center; font-size:28px; color:yellow; text-shadow:0 0 8px black; pointer-events:none; }
</style>
</head>
<body>

<div class="ui">
  <div class="joystick" id="joystick"><div class="stick" id="stick"></div></div>
  <div class="buttons">
    <button id="highjump">â¬†â¬†</button>
    <button id="jump">â¤’</button>
  </div>
</div>
<div class="message" id="message"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
// ---------------- SCENE ----------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);
scene.add(new THREE.DirectionalLight(0xffffff,1).position.set(5,10,5));
scene.add(new THREE.AmbientLight(0xffffff,0.4));

// ---------------- PLAYER ----------------
const player = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({ color:0xff4444 }));
player.position.set(0,2,0);
scene.add(player);

// ---------------- VARIABLES ----------------
let platforms=[], movingPlatforms=[], checkpoints=[], finishLine;
let level=0, checkpointPos=new THREE.Vector3(0,2,0);
const message=document.getElementById("message");
let velocityY=0, onGround=false, speed=0.12, gravity=0.02;

// ---------------- JOYSTICK ----------------
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyX=0, joyY=0;

joystick.addEventListener("touchmove", e=>{
  const rect=joystick.getBoundingClientRect();
  const touch=e.touches[0];
  let x=touch.clientX-rect.left-60;
  let y=touch.clientY-rect.top-60;
  const dist=Math.min(40, Math.hypot(x,y));
  const angle=Math.atan2(y,x);
  joyX=Math.cos(angle)*(dist/40);
  joyY=Math.sin(angle)*(dist/40);
  stick.style.left=35+joyX*40+"px";
  stick.style.top=35+joyY*40+"px";
});
joystick.addEventListener("touchend", ()=>{ joyX=joyY=0; stick.style.left="35px"; stick.style.top="35px"; });

// ---------------- BUTTONS ----------------
document.getElementById("jump").ontouchstart=()=>{ if(onGround){ velocityY=0.35; onGround=false; } };
document.getElementById("highjump").ontouchstart=()=>{ if(onGround){ velocityY=0.65; onGround=false; } };

// ---------------- LEVEL DATA ----------------
const levels=[
  // Level 1: Easy
  [{x:0,y:0,z:0},{x:0,y:1,z:-8},{x:2,y:2,z:-16},{x:-2,y:3,z:-26},{x:0,y:4,z:-36, move:true},{x:0,y:5,z:-46, finish:true}],
  // Level 2: Medium
  [{x:0,y:0,z:0},{x:1,y:1,z:-8},{x:-1,y:2,z:-16},{x:2,y:3,z:-26, move:true},{x:-2,y:4,z:-36},{x:0,y:5,z:-46, move:true},{x:0,y:6,z:-56, finish:true}],
  // Level 3: Hard
  [{x:0,y:0,z:0},{x:1,y:1,z:-8},{x:-1,y:2,z:-16, move:true},{x:2,y:3,z:-24},{x:-2,y:4,z:-34, move:true},{x:1,y:5,z:-44},{x:0,y:6,z:-54, finish:true}],
  // Level 4: Harder
  [{x:0,y:0,z:0},{x:2,y:1,z:-8},{x:-2,y:2,z:-16},{x:3,y:3,z:-26, move:true},{x:-3,y:4,z:-36, move:true},{x:2,y:5,z:-46},{x:0,y:6,z:-56, finish:true}],
  // Level 5: Hardest
  [{x:0,y:0,z:0},{x:2,y:1,z:-8, move:true},{x:-2,y:2,z:-16},{x:3,y:3,z:-26, move:true},{x:-3,y:4,z:-36, move:true},{x:2,y:5,z:-46, move:true},{x:0,y:6,z:-56, finish:true}]
];

// ---------------- LEVEL LOAD ----------------
function loadLevel(n){
  platforms.forEach(p=>scene.remove(p.mesh));
  platforms=[]; movingPlatforms=[]; checkpoints=[]; finishLine=null;
  checkpointPos.set(0,2,0); velocityY=0; player.position.copy(checkpointPos);

  levels[n].forEach(b=>{
    const p=new THREE.Mesh(new THREE.BoxGeometry(b.move?3:5,1,5),
      new THREE.MeshStandardMaterial({color:b.finish?0xffff00:(b.move?0xffaa00:0x22ff22)}));
    p.position.set(b.x,b.y,b.z);
    scene.add(p);
    platforms.push({mesh:p, move:b.move||false, startX:b.x, dir:1});
    checkpoints.push(new THREE.Vector3(b.x, b.y+1, b.z));
    if(b.finish) finishLine=p;
  });
}
loadLevel(level);

// ---------------- GAME LOOP ----------------
function animate(){
  requestAnimationFrame(animate);

  // Movement
  player.position.x += joyX*speed;
  player.position.z += joyY*speed;

  // Gravity
  velocityY -= gravity; player.position.y += velocityY;

  // Moving platforms
  platforms.forEach(p=>{
    if(p.move){ p.mesh.position.x += 0.03*p.dir; if(Math.abs(p.mesh.position.x-p.startX)>3) p.dir*=-1; }
  });

  // Collision & checkpoint
  onGround=false;
  platforms.forEach((p,i)=>{
    const dx=Math.abs(player.position.x-p.mesh.position.x);
    const dz=Math.abs(player.position.z-p.mesh.position.z);
    const dy=player.position.y-p.mesh.position.y;
    if(dx<2.5 && dz<2.5 && dy<=1 && dy>0){
      velocityY=0; player.position.y=p.mesh.position.y+1; onGround=true;
      checkpointPos.copy(checkpoints[i]);
    }
  });

  // Finish line
  if(finishLine){
    const dx=Math.abs(player.position.x-finishLine.position.x);
    const dz=Math.abs(player.position.z-finishLine.position.z);
    const dy=Math.abs(player.position.y-finishLine.position.y);
    if(dx<2.5 && dz<2.5 && dy<2){
      message.textContent=`Level ${level+1} Complete!`;
      setTimeout(()=>{
        message.textContent="";
        level++;
        if(level>=levels.length) message.textContent="You finished all 5 levels! ðŸŽ‰";
        else loadLevel(level);
      },1000);
    }
  }

  // Respawn if fall
  if(player.position.y<-20){ player.position.copy(checkpointPos); velocityY=0; }

  // Camera follow
  camera.position.set(player.position.x, player.position.y+6, player.position.z+12);
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
animate();

// ---------------- RESIZE ----------------
addEventListener("resize",()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
