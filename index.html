<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
<title>Ultimate Mobile Obby</title>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:linear-gradient(#6fd3ff,#baf0ff);
  font-family:system-ui;
}
canvas{display:block}

#hud{
  position:absolute;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.35);
  color:#fff;
  padding:8px 16px;
  border-radius:14px;
  font-size:15px;
}

#joystick{
  position:absolute;
  bottom:30px;
  left:30px;
  width:130px;
  height:130px;
  border-radius:50%;
  background:rgba(255,255,255,.25);
  touch-action:none;
}
#stick{
  position:absolute;
  left:45px;
  top:45px;
  width:40px;
  height:40px;
  border-radius:50%;
  background:#fff;
}

#jump{
  position:absolute;
  bottom:45px;
  right:40px;
  width:75px;
  height:75px;
  border-radius:50%;
  border:none;
  font-size:22px;
  color:#fff;
  background:linear-gradient(#ff7a7a,#e84141);
}
</style>
</head>

<body>
<div id="hud">OBBY · Level 1 · CP 1</div>
<div id="joystick"><div id="stick"></div></div>
<button id="jump">⬆</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
const hud = document.getElementById('hud');
let scene,camera,renderer,player;
let platforms=[],hazards=[],spinners=[],checkpoints=[];
let velocity=new THREE.Vector3();
let canJump=false;
let joyX=0,joyY=0;
let camYaw=0;
let cpIndex=0;

const gravity=0.013;
const speed=0.12;
const jumpPower=0.28;

init();
animate();

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);

  camera=new THREE.PerspectiveCamera(65,innerWidth/innerHeight,0.1,300);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const sun=new THREE.DirectionalLight(0xffffff,1);
  sun.position.set(15,25,10);
  scene.add(sun);

  player=new THREE.Mesh(
    new THREE.CapsuleGeometry(0.35,0.8,8,16),
    new THREE.MeshStandardMaterial({color:0xff4d4d})
  );
  player.position.set(0,1,0);
  scene.add(player);

  buildLevel();
  setupJoystick();
  setupJump();
  setupCameraSwipe();

  addEventListener('resize',onResize);
}

function buildLevel(){
  [...platforms,...hazards,...spinners,...checkpoints].forEach(o=>scene.remove(o));
  platforms=[];hazards=[];spinners=[];checkpoints=[];
  cpIndex=0;

  addPlatform(0,0,0,8,1,8,0xffffff);

  const cols=[0xff3b3b,0xffa801,0x2ed573,0x1e90ff,0xbe2edd];
  for(let i=0;i<6;i++){
    addPlatform(i*4,1+i*1.1,-i*4,3,.6,3,cols[i%cols.length]);
  }

  addSpinner(12,1.6,-12);
  addHazard(18,1.2,-18);

  addCheckpointOnPlatform(platforms[2]);
  addCheckpointOnPlatform(platforms[5]);

  updateHUD();
}

function addPlatform(x,y,z,w,h,d,c){
  const m=new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color:c})
  );
  m.position.set(x,y+h/2,z);
  m.userData={w,h,d};
  scene.add(m);
  platforms.push(m);
}

function addHazard(x,y,z){
  const m=new THREE.Mesh(
    new THREE.BoxGeometry(3,.4,3),
    new THREE.MeshStandardMaterial({color:0xff0000,emissive:0x550000})
  );
  m.position.set(x,y,z);
  m.userData={w:3,h:.4,d:3};
  scene.add(m);
  hazards.push(m);
}

function addSpinner(x,y,z){
  const m=new THREE.Mesh(
    new THREE.BoxGeometry(6,.3,.5),
    new THREE.MeshStandardMaterial({color:0xffa801})
  );
  m.position.set(x,y,z);
  m.userData={speed:0.05};
  scene.add(m);
  spinners.push(m);
}

function addCheckpointOnPlatform(platform){
  const {w,h,d} = platform.userData;
  const m=new THREE.Mesh(
    new THREE.TorusGeometry(.5,.15,12,20),
    new THREE.MeshStandardMaterial({color:0x2ecc71,emissive:0x116633})
  );
  m.position.set(platform.position.x, platform.position.y + h/2 + 0.5, platform.position.z);
  m.rotation.x=Math.PI/2;
  scene.add(m);
  checkpoints.push(m);
}

function setupJoystick(){
  const joy=document.getElementById('joystick');
  const stick=document.getElementById('stick');
  let active=false;

  joy.addEventListener('touchstart',()=>active=true);
  joy.addEventListener('touchend',()=>{
    active=false;joyX=joyY=0;
    stick.style.left='45px';stick.style.top='45px';
  });

  joy.addEventListener('touchmove',e=>{
    if(!active)return;
    const r=joy.getBoundingClientRect();
    const t=e.touches[0];
    const x=t.clientX-r.left-65;
    const y=t.clientY-r.top-65;
    const d=Math.min(45,Math.hypot(x,y));
    const a=Math.atan2(y,x);
    joyX=Math.cos(a)*(d/45);
    joyY=Math.sin(a)*(d/45);
    stick.style.left=45+joyX*45+'px';
    stick.style.top=45+joyY*45+'px';
  });
}

function setupJump(){
  document.getElementById('jump').addEventListener('touchstart',()=>{
    if(canJump){
      velocity.y=jumpPower;
      canJump=false;
    }
  });
}

function setupCameraSwipe(){
  let lastX=null;
  addEventListener('touchmove',e=>{
    if(e.touches.length!==1)return;
    if(lastX!==null){
      camYaw+=(e.touches[0].clientX-lastX)*0.005;
    }
    lastX=e.touches[0].clientX;
  });
  addEventListener('touchend',()=>lastX=null);
}

function animate(){
  requestAnimationFrame(animate);

  spinners.forEach(s=>s.rotation.y+=s.userData.speed);

  const f=new THREE.Vector3(Math.sin(camYaw),0,Math.cos(camYaw));
  const r=new THREE.Vector3(Math.cos(camYaw),0,-Math.sin(camYaw));
  player.position.addScaledVector(f, joyY * speed);
  player.position.addScaledVector(r, joyX * speed);

  velocity.y-=gravity;
  player.position.y+=velocity.y;
  canJump=false;

  platforms.forEach(p=>{
    if(hit(p)){
      player.position.y=p.position.y+p.userData.h/2+0.6;
      velocity.y=0;
      canJump=true;
    }
  });

  hazards.forEach(h=>{ if(hit(h)) reset(); });

  checkpoints.forEach((c,i)=>{
    if(player.position.distanceTo(c.position)<1){
      cpIndex=i;updateHUD();
    }
  });

  if(player.position.y<-15) reset();

  const dist=10;
  camera.position.set(
    player.position.x+Math.sin(camYaw)*dist,
    player.position.y+6,
    player.position.z+Math.cos(camYaw)*dist
  );
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}

function hit(o){
  const {w,h,d}=o.userData;
  return (
    player.position.x > o.position.x - w/2 &&
    player.position.x < o.position.x + w/2 &&
    player.position.z > o.position.z - d
