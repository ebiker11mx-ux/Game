<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>3D Obstacle Course - Arrows</title>
<style>
  html, body { margin:0; height:100%; background:#0d1117; overflow:hidden; font-family:system-ui,Arial; }
  #game { position:fixed; inset:0; }
  .hud { position:fixed; inset:0; pointer-events:none; }
  /* Arrow controls */
  .arrows { position:absolute; bottom:12px; left:12px; display:grid; grid-template-columns:60px 60px 60px; grid-template-rows:60px 60px; gap:6px; pointer-events:auto; }
  .arrow { background:#3a8ffd; color:#fff; font-weight:bold; font-size:20px; border:none; border-radius:8px; }
  .arrow:active { background:#1663d9; }
  .buttons { position:absolute; bottom:12px; right:12px; display:flex; gap:10px; pointer-events:auto; }
  .btn { min-width:72px; min-height:72px; border-radius:12px; background:#3a8ffd; color:#fff; font-weight:700; border:none; font-size:14px; }
  .btn.secondary { background:#ff9b3a; }
  .status { position:absolute; top:8px; left:8px; color:#eaf1ff; font-size:13px; background:rgba(0,0,0,0.35); padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="hud">
  <!-- Arrow controls -->
  <div class="arrows">
    <div></div><button id="upBtn" class="arrow">⬆️</button><div></div>
    <button id="leftBtn" class="arrow">⬅️</button><button id="downBtn" class="arrow">⬇️</button><button id="rightBtn" class="arrow">➡️</button>
  </div>
  <!-- Jump buttons -->
  <div class="buttons">
    <button id="jumpBtn" class="btn">Jump</button>
    <button id="doubleJumpBtn" class="btn secondary">Double</button>
  </div>
  <!-- HUD -->
  <div class="status">
    <div>Checkpoint: <span id="checkpointIdx">0</span></div>
    <div>Coins: <span id="coinCount">0</span></div>
    <div>Time: <span id="timer">0.0s</span></div>
  </div>
</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  const canvas=document.getElementById('game');
  const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  const scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0d1117);
  const camera=new THREE.PerspectiveCamera(65,window.innerWidth/window.innerHeight,0.1,500);
  camera.position.set(0,8,12);

  // Lights
  scene.add(new THREE.HemisphereLight(0xffffff,0x223355,0.6));
  const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(10,20,10); scene.add(dir);

  // Player
  const player=new THREE.Mesh(new THREE.SphereGeometry(0.6,16,12),new THREE.MeshStandardMaterial({color:0x86b9ff}));
  scene.add(player);

  const state={pos:new THREE.Vector3(0,2,0),vel:new THREE.Vector3(),onGround:false,jumpCount:0,lastCheckpoint:new THREE.Vector3(0,2,0),checkpointIndex:0,coins:0,startTime:performance.now()};

  // Platforms
  const platforms=[],group=new THREE.Group(); scene.add(group);
  let zOffset=0;
  for(let i=0;i<12;i++){ zOffset-=5;
    const plat=new THREE.Mesh(new THREE.BoxGeometry(5-i*0.2,0.8,5-i*0.2),new THREE.MeshStandardMaterial({color:0x2a3758}));
    plat.position.set((Math.random()-0.5)*4,0.5,zOffset);
    plat.userData.index=i+1;
    group.add(plat); platforms.push(plat);
  }

  // Coins
  const coinGeo=new THREE.TorusGeometry(0.4,0.15,12,24);
  const coinMat=new THREE.MeshStandardMaterial({color:0xffd700});
  const coins=[];
  for(let i=0;i<8;i++){ const c=new THREE.Mesh(coinGeo,coinMat);
    c.position.set((Math.random()-0.5)*4,2,-i*8-10); scene.add(c); coins.push(c); }

  // Finish portal
  const portal=new THREE.Mesh(new THREE.RingGeometry(2,2.5,32),new THREE.MeshBasicMaterial({color:0x00ffcc,side:THREE.DoubleSide}));
  portal.rotation.y=Math.PI/2; portal.position.set(0,2,zOffset-10); scene.add(portal);

  // Arrow buttons
  let input={x:0,z:0};
  function bindArrow(id,dx,dz){
    const btn=document.getElementById(id);
    btn.addEventListener('touchstart',()=>{input.x+=dx; input.z+=dz;});
    btn.addEventListener('touchend',()=>{input.x-=dx; input.z-=dz;});
    btn.addEventListener('mousedown',()=>{input.x+=dx; input.z+=dz;});
    btn.addEventListener('mouseup',()=>{input.x-=dx; input.z-=dz;});
  }
  bindArrow('upBtn',0,-1);
  bindArrow('downBtn',0,1);
  bindArrow('leftBtn',-1,0);
  bindArrow('rightBtn',1,0);

  // Jump buttons
  document.getElementById('jumpBtn').onclick=()=>{if(state.onGround){state.vel.y=9; state.onGround=false; state.jumpCount=1;}};
  document.getElementById('doubleJumpBtn').onclick=()=>{if(!state.onGround&&state.jumpCount===1){state.vel.y=9; state.jumpCount=2;}};

  // Physics constants
  const GRAVITY=-20,MOVE_ACCEL=28,AIR_ACCEL=12,MAX_SPEED=8.5,FRICTION=14;

  function loop(){
    const dt=0.016;
    // Movement
    const accel=state.onGround?MOVE_ACCEL:AIR_ACCEL;
    state.vel.x+=input.x*accel*dt;
    state.vel.z+=input.z*accel*dt;
    state.vel.y+=GRAVITY*dt;
    state.pos.addScaledVector(state.vel,dt);

    // Collision with platforms
    state.onGround=false;
    for(const plat of platforms){
      const p=plat.position,w=plat.geometry.parameters.width,d=plat.geometry.parameters.depth;
      if(state.pos.x>p.x-w/2&&state.pos.x<p.x+w/2&&state.pos.z>p.z-d/2&&state.pos.z<p.z+d/2){
        const top=p.y+0.4;
        if(state.pos.y-0.6<=top&&state.vel.y<=0){state.pos.y=top+0.6; state.vel.y=0; state.onGround=true; state.lastCheckpoint.copy(p).add(new THREE.Vector3(0,2,0)); state.checkpointIndex=plat.userData.index; document.getElementById('checkpointIdx').textContent=state.checkpointIndex;}
      }
    }

    // Coin collection
    for(const c of coins){ if(c.visible&&state.pos.distanceTo(c.position)<1){c.visible=false; state.coins++; document.getElementById('coinCount').textContent=state.coins;} }

    // Fall respawn
    if(state.pos.y<-20){state.pos.copy(state.lastCheckpoint); state.vel.set(0,0,0);}

    // Finish
    if(state.pos.distanceTo(portal.position)<3){alert(`Finished! Coins: ${state.coins}`); state.pos.copy(platforms[0].position).add(new THREE.Vector3(0,2,0)); state.coins=0; for(const c of coins)c.visible=true;}

    // Camera follow
    camera.position.lerp(new THREE.Vector3(state.pos.x
